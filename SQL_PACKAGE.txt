create or replace PACKAGE  BODY KACHAN_AN_ORDERS_PACK
IS

--ДОБАВЛЕНИЕ ДАННЫХ В ТАБЛИЦУ RATING_MOVIES
PROCEDURE RATING_MOVIES_F
IS
BEGIN
EXECUTE IMMEDIATE 'TRUNCATE TABLE RATING_MOVIES DROP STORAGE';
            INSERT INTO RATING_MOVIES
            (ID_FILM
            ,TITLE
            ,GENRE
            ,DURATION
            ,COUNTRY
            ,YEAR_
            ,BUDGET
            ,USA_GROSS_INCOME
            ,WORLWIDE_GROSS_INCOME
            ,FIO_ACTOR_ACTRESS
            ,VOTES_10
            ,VOTES_9
            ,VOTES_8
            ,VOTES_7
            ,VOTES_6
            ,VOTES_5
            ,VOTES_4
            ,VOTES_3
            ,VOTES_2
            ,VOTES_1
            ,ALLGENDERS_0AGE_AVG_VOTE
            ,ALLGENDERS_0AGE_VOTES
            ,ALLGENDERS_18AGE_AVG_VOTE
            ,ALLGENDERS_18AGE_VOTES
            ,ALLGENDERS_30AGE_AVG_VOTE
            ,ALLGENDERS_30AGE_VOTES
            ,ALLGENDERS_45AGE_AVG_VOTE
            ,ALLGENDERS_45AGE_VOTES
            ,MALES_ALLAGES_AVG_VOTE
            ,MALES_ALLAGES_VOTES
            ,MALES_0AGE_AVG_VOTE
            ,MALES_0AGE_VOTES
            ,MALES_18AGE_AVG_VOTE
            ,MALES_18AGE_VOTES
            ,MALES_30AGE_AVG_VOTE
            ,MALES_30AGE_VOTES
            ,MALES_45AGE_AVG_VOTE
            ,MALES_45AGE_VOTES
            ,FEMALES_ALLAGES_AVG_VOTE
            ,FEMALES_ALLAGES_VOTES
            ,FEMALES_0AGE_AVG_VOTE
            ,FEMALES_0AGE_VOTES
            ,FEMALES_18AGE_AVG_VOTE
            ,FEMALES_18AGE_VOTES
            ,FEMALES_30AGE_AVG_VOTE
            ,FEMALES_30AGE_VOTES
            ,FEMALES_45AGE_AVG_VOTE
            ,FEMALES_45AGE_VOTES
            ,TOP1000_VOTERS_RATING
            ,TOP1000_VOTERS_VOTES
            ,US_VOTERS_RATING
            ,US_VOTERS_VOTES
            ,NON_US_VOTERS_RATING
            ,NON_US_VOTERS_VOTES
            )
            SELECT  MOV.IMDB_TITLE_ID AS ID_FILM
    ,MOV.TITLE
    ,MOV.GENRE
    ,MOV.DURATION
    ,MOV.COUNTRY
    ,EXTRACT(YEAR FROM MOV.DATE_PUBLISHED) AS YEAR_
    ,MOV.BUDGET
    ,MOV.USA_GROSS_INCOME
    ,MOV.WORLWIDE_GROSS_INCOME
    ,NAM.NAME AS FIO_ACTOR_ACTRESS
    ,RAT.VOTES_10
    ,RAT.VOTES_9
    ,RAT.VOTES_8
    ,RAT.VOTES_7
    ,RAT.VOTES_6
    ,RAT.VOTES_5
    ,RAT.VOTES_4
    ,RAT.VOTES_3
    ,RAT.VOTES_2
    ,RAT.VOTES_1
    ,RAT.ALLGENDERS_0AGE_AVG_VOTE
    ,RAT.ALLGENDERS_0AGE_VOTES
    ,RAT.ALLGENDERS_18AGE_AVG_VOTE
    ,RAT.ALLGENDERS_18AGE_VOTES
    ,RAT.ALLGENDERS_30AGE_AVG_VOTE
    ,RAT.ALLGENDERS_30AGE_VOTES
    ,RAT.ALLGENDERS_45AGE_AVG_VOTE
    ,RAT.ALLGENDERS_45AGE_VOTES
    ,RAT.MALES_ALLAGES_AVG_VOTE
    ,RAT.MALES_ALLAGES_VOTES
    ,RAT.MALES_0AGE_AVG_VOTE
    ,RAT.MALES_0AGE_VOTES
    ,RAT.MALES_18AGE_AVG_VOTE
    ,RAT.MALES_18AGE_VOTES
    ,RAT.MALES_30AGE_AVG_VOTE
    ,RAT.MALES_30AGE_VOTES
    ,RAT.MALES_45AGE_AVG_VOTE
    ,RAT.MALES_45AGE_VOTES
    ,RAT.FEMALES_ALLAGES_AVG_VOTE
    ,RAT.FEMALES_ALLAGES_VOTES
    ,RAT.FEMALES_0AGE_AVG_VOTE
    ,RAT.FEMALES_0AGE_VOTES
    ,RAT.FEMALES_18AGE_AVG_VOTE
    ,RAT.FEMALES_18AGE_VOTES
    ,RAT.FEMALES_30AGE_AVG_VOTE
    ,RAT.FEMALES_30AGE_VOTES
    ,RAT.FEMALES_45AGE_AVG_VOTE
    ,RAT.FEMALES_45AGE_VOTES
    ,RAT.TOP1000_VOTERS_RATING
    ,RAT.TOP1000_VOTERS_VOTES
    ,RAT.US_VOTERS_RATING
    ,RAT.US_VOTERS_VOTES
    ,RAT.NON_US_VOTERS_RATING
    ,RAT.NON_US_VOTERS_VOTES
    
    
    FROM MOVIES MOV
    LEFT OUTER JOIN RATING RAT on MOV.IMDB_TITLE_ID=RAT.IMDB_TITLE_ID
    LEFT OUTER JOIN PRINCIPALS PR on MOV.IMDB_TITLE_ID=PR.IMDB_TITLE_ID
    LEFT OUTER JOIN NAMES NAM on NAM.IMDB_NAME_ID=PR.IMDB_NAME_ID;
    COMMIT;

END RATING_MOVIES_F;


-------------------------------------------------------------

--ДОБАВЛЕНИЕ ДАННЫХ В ТАБЛИЦУ RATING_AGGR
PROCEDURE RATING_AGGR_F
IS 
BEGIN
EXECUTE IMMEDIATE 'TRUNCATE TABLE RATING_AGGR DROP STORAGE';
INSERT INTO  RATING_AGGR(
    GENRE
    ,COUNT_FILMS
    ,DURATION
    ,ALLGENDERS_0AGE_AVG_VOTE
    ,ALLGENDERS_18AGE_AVG_VOTE
    ,ALLGENDERS_30AGE_AVG_VOTE
    ,ALLGENDERS_45AGE_AVG_VOTE
    ,MALES_ALLAGES_AVG_VOTE
    ,MALES_0AGE_AVG_VOTE
    ,MALES_18AGE_AVG_VOTE
    ,MALES_30AGE_AVG_VOTE
    ,MALES_45AGE_AVG_VOTE
    ,FEMALES_ALLAGES_AVG_VOTE
    ,FEMALES_0AGE_AVG_VOTE
    ,FEMALES_18AGE_AVG_VOTE
    ,FEMALES_30AGE_AVG_VOTE
    ,FEMALES_45AGE_AVG_VOTE
    ,TOP1000_VOTERS_RATING
    ,US_VOTERS_RATING
    ,NON_US_VOTERS_RATING
)
SELECT 
    GENRE
    ,COUNT(ID_FILM) AS COUNT_FILMS
    ,ROUND(AVG(DURATION),1) AS DURATION
    ,ROUND(AVG(ALLGENDERS_0AGE_AVG_VOTE),1) AS ALLGENDERS_0AGE_AVG_VOTE
    ,ROUND(AVG(ALLGENDERS_18AGE_AVG_VOTE),1) AS ALLGENDERS_18AGE_AVG_VOTE
    ,ROUND(AVG(ALLGENDERS_30AGE_AVG_VOTE),1) AS ALLGENDERS_30AGE_AVG_VOTE
    ,ROUND(AVG(ALLGENDERS_45AGE_AVG_VOTE),1) AS ALLGENDERS_45AGE_AVG_VOTE
    ,ROUND(AVG(MALES_ALLAGES_AVG_VOTE),1) AS MALES_ALLAGES_AVG_VOTE
    ,ROUND(AVG(MALES_0AGE_AVG_VOTE),1) AS MALES_0AGE_AVG_VOTE
    ,ROUND(AVG(MALES_18AGE_AVG_VOTE),1) AS MALES_18AGE_AVG_VOTE
    ,ROUND(AVG(MALES_30AGE_AVG_VOTE),1) AS MALES_30AGE_AVG_VOTE
    ,ROUND(AVG(MALES_45AGE_AVG_VOTE),1) AS MALES_45AGE_AVG_VOTE
    ,ROUND(AVG(FEMALES_ALLAGES_AVG_VOTE),1) AS FEMALES_ALLAGES_AVG_VOTE
    ,ROUND(AVG(FEMALES_0AGE_AVG_VOTE),1) AS FEMALES_0AGE_AVG_VOTE
    ,ROUND(AVG(FEMALES_18AGE_AVG_VOTE),1) AS FEMALES_18AGE_AVG_VOTE
    ,ROUND(AVG(FEMALES_30AGE_AVG_VOTE),1) AS FEMALES_30AGE_AVG_VOTE
    ,ROUND(AVG(FEMALES_45AGE_AVG_VOTE),1) AS FEMALES_45AGE_AVG_VOTE
    ,ROUND(AVG(TOP1000_VOTERS_RATING),1) AS TOP1000_VOTERS_RATING
    ,ROUND(AVG(US_VOTERS_RATING),1) AS US_VOTERS_RATING
    ,ROUND(AVG(NON_US_VOTERS_RATING),1) AS NON_US_VOTERS_RATING

FROM RATING_MOVIES
GROUP BY
    GENRE
ORDER BY GENRE;

COMMIT;

END RATING_AGGR_F;

END KACHAN_AN_ORDERS_PACK;